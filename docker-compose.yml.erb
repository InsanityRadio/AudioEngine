version: '2'

services:
<% config['stations'].each do | station | %>
  ingest_<%= station['name'] %>:
    build:
      context: docker/ingest
      args:
        - http_proxy
        - https_proxy
        - HTTP_PROXY
        - HTTPS_PROXY
<% if station['ingest']['type'] == 'card' %>
    privileged: true
    volumes:
      - /dev/snd:/dev/snd
<% end %>
    environment:
      - INGEST_NAME=<%= station['name'] %>
      - INGEST_TYPE=<%= station['ingest']['type'] %>
      - INGEST_URI=<%= station['ingest']['uri'] %>
      - AUTH=<%= icecast['source_password'] %>

<% station['mounts'].each do | mount | %>

  tc_<%= station['name']%>_<%= mount['id'] %>:
    build:
      context: docker/transcode
      args:
        - http_proxy
        - https_proxy
        - HTTP_PROXY
        - HTTPS_PROXY
    environment:
      - INGEST_NAME=<%= station['name'] %>
      - INGEST_CODEC=<%= mount['codec'] %>
      - INGEST_PROCESSED=<%= mount['processed'] ? 1 : 0 %>
      - INGEST_BITRATE=<%= mount['bitrate'] %>
      - EGRESS_NAME=<%= mount['egress'] %>
      - AUTH=<%= icecast['source_password'] %>

<% end %>

<% if station['processed'] %>

  dsp_<%= station['name'] %>:
    build:
      context: docker/stereo_tool
      args:
        - http_proxy
        - https_proxy
        - HTTP_PROXY
        - HTTPS_PROXY
    environment:
      - INGEST_NAME=<%= station['name'] %>
      - AUTH=<%= icecast['source_password'] %>
<% end %>
<% end %>
  icecast:
    #restart: always
    ports:
      - "8000:8000"
    build:
      context: docker/icecast
      args:
        - http_proxy
        - https_proxy
        - HTTP_PROXY
        - HTTPS_PROXY
